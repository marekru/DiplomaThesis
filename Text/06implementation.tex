\chapter{Návrh systému a Implementácia}
Pri návrhu a implementácii našej aplikácie sme brali do úvahy výhody a obmedzenia systému \textit{IMS4} (\textit{Integrated Monitoring System}), ktorý je vyvíjaný spoločnosťou \textit{MicroStep-MIS s.r.o.}. Dôvodom je, že náš verifikačný systém bol navrhovaný ako prídavný modul pre IMS4.

V tejto kapitole stručne zhrnieme návrh systému a opíšeme kľúčové časti implementácie.


\section{Návrh systému}
Našu aplikáciu sme sa snažili navrhnúť jednak ako samostatný produkt schopný extrakcie a spracovania meteorologických dát a výpočtu verifikačných štatistík, ale taktiež aj ako súčasť systému IMS4. Toto sme dosiahli tak, že sme rozdelili systém na 2 balíky: \textit{verifikačný} a \textit{vizualizačný}. Na obrázku \ref{fig:system} môžme vidieť schematický návrh systému.

\textit{Verifikačný balík} tvorí jadro celého systému a zohráva viacero úloh. V prvom rade je jeho úlohou extrakcia dát z rôznych dátových zdrojov do tabuliek predpovedí a pozorovaní. Tieto tabuľky sa následne predspracúvajú (párovanie, konverzia fyzikálnych jednotiek, filtrovanie, identifikácia chýbajúcich dát...) a posúvajú sa do časti na výpočet štatistík. Na základe konfigurácie sa spočítajú rôzne štatistiky, ktorých výsledok je výstup z tohoto balíka.

\textit{Vizualizačný balík} chápeme ako vymeniteľnú časť systému. Vďaka tomuto môže byť vizualizácia v podobe interaktívnej obrazovky, ktorá je súčasťou systému IMS4, ale taktiež generovaná automaticky do statických obrázkov na disku.

\begin{figure}
	\centering
	\includegraphics[width = 5in]{system}
	\caption{Schematický popis systému.}
	\label{fig:system} 
\end{figure}

Ak by sme mali systém opísať v pojmoch vizualizácie informácií, tak tieto dva balíky rozdeľujú vizualizačnú \textit{pipeline} na dve časti (Pozri obrázok \ref{fig:pipeline}). Verifikačný balík sa stará o analýzu dát pomocou predspracovania a matematického modelu verifikačných štatistík a taktiež sa stará o filtrovanie dát. Zvyčajne filtrovanie prebieha na základe interakcie užívateľa. V našom prípade sme však uvažovali aj o možnosti, že vizualizácia nebude interaktívna, preto sme filtrovanie umiestnili do verifikačného balíka a vykonáva sa na základe konfigurácie systému. 

Filtrované dáta putujú do vizualizačného balíka. V ňom sa vykonáva zobrazenie hodnôt na vizuálne parametre jednotlivých prvkov vizualizácie, tak ako sme to opísali v kapitole \ref{chap:design} \textit{Návrh vizualizácie}. Takéto dáta sa následne vykreslia do obrázka alebo na obrazovku, čím sa ukončí vizualizačná pipeline.

\begin{figure}
	\centering
	\includegraphics[width = 6in]{pipeline}
	\caption{Rozdelenie prvkov vizualizačnej pipeline do verifikačného a vizualizačného balíka. Obrázok pipeline pochádza zo stránky \protect\url{http://www.infovis-wiki.net}.}
	\label{fig:pipeline} 
\end{figure}

\section{Verifikačný balík}
Ako sme už spomenuli v predchádzajúcej sekcii, tento balík sa skladá z dvoch logických častí \textit{Spracovanie dát} a \textit{Výpočet štatistík}. V tejto sekcii sa pokúsime zhrnúť kľúčové prvky návrhu a implementácie týchto dvoch častí.
\subsection{Spracovanie dát}
Úlohou tejto časti je získanie potrebných dát z určených dátových zdrojov a ich predspracovanie tak, aby mohli vstúpiť do ďalšej časti - \textit{Výpoečt štatistík}.

Pri návrhu tried na získavanie predpovedí a pozorovaní sme sa snažili, aby bolo užívateľovi umožnené získavať dáta z viacerých typov zdrojov: Gribovské súbory, CSV súbory, webové zdroje, databáza a podobne. Aby sme pre každý typ zdroju nevytvárali samostatnú vetvu udalostí, navrhli sme abstraktnú triedu \textit{DataExtractor}, ktorá obsahuje abstraktné metódy \texttt{extract()} a \texttt{addSoruces()} a taktiež slúži na inštancovanie všetkých jej potomkov (pozri UML diagram na obrázku \ref{fig:dataextractor}). Jednotlivý potomkovia následne musia implementovať vyššie spomenuté metódy, ktoré sú špecifické pre každý typ zdroju.

Z extrakcie dát získame tabuľky hodnôt s pozorovaniami a predpoveďami pre konkrétne časy. Tieto dáta sa následné predspracúvajú v štyroch krokoch:

\begin{enumerate}
	\item \textit{Párovanie} : Prebieha tak ako je opísané v podsekcii \ref{subsec:pairing}.
	\item \textit{Filtrovanie} : Na základe konfigurácie získavame iba dátumy zvolené užívateľom.	\item \textit{Konverzia jednotiek} : Fyzikálne jednotky z predpovedí a pozorovaní konvertujeme do rovnakej jednotky podľa konfigurácie, aby bol výpočet chýb korektný.
	\item \textit{Výpočet chýb} : Prebieha tak ako je opísané v sekcii \ref{sec:errormeasurement}.
\end{enumerate}

\noindent Tak ako je naznačené na obrázku \ref{fig:system},  takto spracované dáta putujú do časti výpočet štatistík.

\begin{figure}
	\centering
	\includegraphics[width = 5.5in]{dataextractor}
	\caption{Triedny UML diagram pre triedy typu DataExtractor.}
	\label{fig:dataextractor} 
\end{figure}

\subsection{Výpočet štatistík}
V tejto časti verifikačného balíka sa vykonáva výpočet štatistík, z ktorých sme väčšinu opísali v sekcii \ref{sec:errormeasurement}. 

Pri implementácii sme využili nami navrhnutý všeobecný spôsob výpočtu kumulovanej chyby (pozri podsekciu \ref{subsec:cumulativeerror}). Pripomenieme, že sme v našom využili vzorci dve funkcie $ \Phi $ a $ \varepsilon $, ktoré obe boli ľubovoľnými funkciami z $\mathbb{R}$ do $\mathbb{R}$. Na obrázku \ref{fig:stats} je triedny diagram pre balík na výpočet spojitých štatistík, v ktorom môžme vidieť abstraktnú triedu \textit{ContinuousStatistics}, ktorá reprezentuje ľubovoľnú štatistickú metódu na výpočet kumulovanej chyby opísanú v sekcii \ref{sec:errormeasurement}. Abstraktné metódy \texttt{processError()} a \texttt{processSum()} patriace tejto triede predstavujú funkcie $ \Phi $ a $ \varepsilon $. Vidíme, že všetky štatistiky sú implementované ako potomkovia triedy \textit{ContinuousStatistics} a implementujú tieto vyššie spomenuté metódy. 

%TODO\pagebreak

%Lorem ipsum dolor sit amet Lorem ipsum dolor sit amet Lorem ipsum dolor sit amet  Lorem ipsum dolor sit amet Lorem ipsum dolor sit amet Lorem ipsum dolor sit amet Lorem ipsum dolor sit amet Lorem ipsum dolor sit amet Lorem ipsum dolor sit amet Lorem ipsum dolor sit amet Lorem ipsum dolor sit amet Lorem ipsum dolor sit amet Lorem ipsum dolor sit amet Lorem ipsum dolor sit amet Lorem ipsum dolor sit amet Lorem ipsum dolor sit amet Lorem ipsum dolor sit amet              

\begin{figure}
	\centering
	\includegraphics[width = 5in]{stats}
	\caption{Triedny UML diagram pre triedy typu ContinuousStatistics.}
	\label{fig:stats} 
\end{figure}

\section{Vizualizačný balík}


\section{Použité technológie}
V tejto časti rozoberáme technológie použité pre implementácii systému a uvádzame dôvody ich použitia.

\subsection{Java}
Primárnu časť systému - \textit{verifikačný balík} sme implementovali v jazyku \textit{Java}, konkrétne vo verzii 1.5. Toto je prvé obmedzenie, ktoré na nás kladie systém IMS4, keďže použitie vyššej verzie (momentálne je dostupná už verzia 1.8) by spôsoboval problém s kompatibilitou.

Java ako programovací jazyk je veľmi rozšírený a obľúbený, vďaka čomu je dostupných pomerne veľké množstvo knižníc, nevynímajúc originálne knižnice zahrnuté v systéme IMS4. Tieto knižnice sme využili pri implementácii aj my. Môžme spomenúť 3 knižnice, z ktorých sú dve interné a jedna pôvodne externá s pridanou funkcionalitou. Prvé dve spomenuté sú \textit{Log} - používaná na logovanie a \textit{X2O}, ktorá sa používa na mapovanie javovských objektov na XML štruktúru a späť pomocou \textit{Java Reflection API}. My sme X2O použili pri ukladaní a načítavaní konfiguračných súborov. Posledná knižnica je NetCDF-grib \cite{XYZ} a pochádza od americkej organizácie \textit{Unidata}, ktorú zastrešuje \textit{UCAR}. Jedná sa o opensource produkt na čítanie dát zo súborov vo formáte GRIB. My využívame upravenú verziu NetCDF-grib-6.0 obzvlášť kvôli Jave 1.5, aj keď sú dostupné novšie verzie \footnote{Najnovšia je NetCDF-Java-4.5, ktorá zoskupuje všetky ďalšie podobné produkty od Unidata.}.

\subsection{JavaScript}
Systém IMS4 využíva webové stránky na vytváranie GUI. Z tohto dôvodu sme sa rozhodli, že vizualizáciu budeme produkovať priamo v prehliadači pomocou \textit{JavaScriptu}. Podobne ako Java, aj JavaScript je veľmi populárny a preto vzniklo veľké množstvo rôznych knižníc, medzi ktorými sú aj mnohé určené na vizualizáciu. Medzi najznámejšie z nich patria napríklad: \textit{JavaScript InfoVis Toolkit}, \textit{Highcharts}, \textit{jQuery Visualize}, \textit{JS Charts}, \textit{jqPlot}, \textit{jpGraph}, \textit{Raphaël}, \textit{Dygraphs},\textit{ Processing.js}, \textit{Axiis}, \textit{D3} a mnohé ďalšie. Pre naše účely sme z veľkého množstva knižníc vybrali práve D3, ako najvhodnejší nástroj na náš účel.

\subsubsection{D3}
D3 (\textit{Data-Driven Documents}) \cite{XYZ} je opensource knižnica napísaná v JavaScripte. Na vizualizáciu využíva HTML a SVG elementy a ich vizuálne vlastnosti, ktoré mení pomocou ich atribútov a CSS štýlov. 

Dôvodom, prečo sme si vybrali práve D3 z veľkého množstva vizualizačných knižníc je, že väčšina z nich bola zameraná na konkrétny druh vizualizácie (napr. \textit{force-directed layout}) alebo na niekoľko najpoužívanejších druhov diagramov (bodový, stĺpcový, čiarový, histogram,...). D3 sa však nezameriava na konkrétny druh vizualizácie, ale ponúka spôsob, ako zobrazovať hodnoty na vizuálne parametre elementov, čím umožňuje ohromnú variabilitu a je vhodná na vytváranie nových alebo menej používaných typov vizualizácií. Väčšina vizualizácií, ktoré sme v našej práci sme navrhli, nie sú podporované vyššie spomenutými knižnicami a preto sme potrebovali nástroj umožňujúci dobre parametrizovateľnú vizualizáciu.

Toto je taktiež dôvod, prečo vzniklo veľké množstvo knižníc, ukážkových príkladov a návodov ktoré využívajú práve D3. Aby sme spomenuli aspoň niektoré z knižníc používajúcich D3, tak sú to napríklad \textit{Raw}, \textit{Cubism}, \textit{Ember Charts}, \textit{NVD3}, \textit{C3}, \textit{MetricsGraphics}, \textit{Graffeine}, \textit{Mermaid}, \textit{Epoch}, \textit{Insights}, \textit{Dashku}, \textit{RickShaw} a mnohé ďalšie. 